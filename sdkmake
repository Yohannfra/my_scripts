#!/bin/bash

# Generate a makefile for an example in the NRF5 SDK
# Usefull for a testing example quickly from the cli

COMMENT_HEADER="# This Makefile was generated by a tool."
FILE="Makefile"
TARGET="pca10056"
TARGET_SOC="nrf52"
PROJ_NAME=$(pwd | rev | cut -d '/' -f1 | rev)

if [[ -f $FILE ]]; then
    echo $FILE already exists
    exit 1
fi

echo "Generating a Makefile for this project ..."
touch Makefile

if ! [[ -d $TARGET ]]; then
    echo $TARGET directory not found
    exit 1
fi

if [[ -d "${TARGET}/s140" ]]; then
    EXE_FILE=${TARGET}/s140/ses/Output/Debug/Exe/${PROJ_NAME}_${TARGET}_s140.hex
    EMPROJECT_FILE=$(find ${TARGET}/s140/ -type f -name "*.emProject")
else # blank dir
    EXE_FILE=${TARGET}/blank/ses/Output/Debug/Exe/${PROJ_NAME}_${TARGET}.hex
    EMPROJECT_FILE=$(find ${TARGET}/blank/ -type f -name "*.emProject")
fi

if ! [[ -f $EMPROJECT_FILE ]]; then
    echo $EMPROJECT_FILE file not found
    exit 1
fi

echo $COMMENT_HEADER > $FILE
echo "" >> $FILE
echo "EMPROJECT_FILE=${EMPROJECT_FILE}" >> $FILE
echo "" >> $FILE
echo "HEX_FILE=${EXE_FILE}" >> $FILE
echo "" >> $FILE
echo "all:" >> $FILE
echo -e "\temBuild -verbose -config "Debug" \$(EMPROJECT_FILE)" >> $FILE
echo -e "\t@echo \"Done !\"" >> $FILE
echo "" >> $FILE

echo "flash:" >> $FILE
echo -e "\t@echo Flashing: \$(HEX_FILE)" >> $FILE
echo -e "\tnrfjprog -f ${TARGET_SOC} --program \$(HEX_FILE) --sectorerase" >> $FILE
echo -e "\tnrfjprog -f ${TARGET_SOC} --reset" >> $FILE

echo "" >> $FILE
echo "clean:" >> $FILE
echo -e "\t\$(RM) -r ./${TARGET}/blank/ses/Output" >> $FILE

echo "" >> $FILE
echo "erase_memory:" >> $FILE
echo -e "\tnrfjprog -f nrf52 -e" >> $FILE

echo "" >> $FILE
echo "re: clean all" >> $FILE

echo "Done !"
